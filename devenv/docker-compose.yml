services:
  magento:
    build:
      context: ..
      dockerfile: devenv/Dockerfile
    env_file:
      - ./app.env
    environment:
      HOST_MODULE_PATH: /srv/module
      HOST_BASE_PATH: /srv/vigilant-healthchecks-base
    volumes:
      - magento_data:/var/www/html
      - ../:/srv/module
      - ../vigilant-healthchecks-base:/srv/vigilant-healthchecks-base
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      opensearch:
        condition: service_healthy

  nginx:
    image: nginx:1.27
    ports:
      - "8000:8000"
    depends_on:
      magento:
        condition: service_started
    volumes:
      - magento_data:/var/www/html:ro
      - ../:/srv/module:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro

  db:
    image: mysql:8.0
    command: --mysqlx=0 --host-cache-size=0 --authentication-policy=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: magento
      MYSQL_USER: magento
      MYSQL_PASSWORD: magento
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-proot"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  redis:
    image: redis:7.4-alpine
    command: redis-server --save '' --appendonly no

  opensearch:
    image: opensearchproject/opensearch:2.12.0
    environment:
      discovery.type: single-node
      plugins.security.disabled: "true"
      compatibility.override_main_response_version: "true"
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
      OPENSEARCH_INITIAL_ADMIN_PASSWORD: "B^QqcHCjd;/%NMj+$k^Gav2%r{8_^^RtM);Y[c-VNMY5!_9N?:.qPt/v1pohDgay"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 20s

volumes:
  magento_data:
  db_data:
  opensearch_data:
